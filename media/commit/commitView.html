<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'none';
                 img-src {{cspSource}} https:;
                 style-src {{cspSource}};
                 script-src 'nonce-{{nonce}}';"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Commit</title>

    <link rel="stylesheet" href="{{cssUri}}" />
  </head>
  <body>
    <div class="muted" id="stagedLabel">Staged: 0</div>

    <div style="margin-top: 8px">
      <textarea id="message" placeholder="Commit Message"></textarea>
    </div>

    <div class="row">
      <label class="row" style="gap: 6px; margin: 0">
        <input id="amend" type="checkbox" />
        <span>Amend</span>
      </label>
      <div class="spacer"></div>
    </div>

    <div class="footer">
      <button class="primary" id="btnCommit">Commit</button>
      <button class="secondary" id="btnCommitPush">Commit & Push</button>
    </div>

    <div class="error" id="error"></div>

    <!-- JS stays inline exactly as before, only nonce is injected -->
    <script nonce="{{nonce}}">
      const vscode = acquireVsCodeApi();

      const stagedLabel = document.getElementById("stagedLabel");
      const messageEl = document.getElementById("message");
      const amendEl = document.getElementById("amend");
      const errorEl = document.getElementById("error");
      const btnCommit = document.getElementById("btnCommit");
      const btnCommitPush = document.getElementById("btnCommitPush");

      let stagedCount = 0;

      const persisted = vscode.getState() || {};
      if (typeof persisted.message === "string")
        messageEl.value = persisted.message;
      if (typeof persisted.amend === "boolean")
        amendEl.checked = persisted.amend;

      function persist() {
        const current = vscode.getState() || {};
        vscode.setState({
          ...current,
          message: messageEl.value,
          amend: amendEl.checked,
        });
      }

      messageEl.addEventListener("input", persist);
      amendEl.addEventListener("change", persist);

      function sendCommit(push) {
        vscode.postMessage({
          type: "commit",
          message: messageEl.value,
          amend: amendEl.checked,
          push,
        });
      }

      function tryCommit(push) {
        const isAmend = Boolean(amendEl.checked);

        if ((stagedCount ?? 0) === 0) {
          if (isAmend) {
            sendCommit(push);
            return;
          }
          if (push) {
            sendCommit(true);
            return;
          }
          vscode.postMessage({ type: "notify", kind: "no-staged" });
          return;
        }

        sendCommit(push);
      }

      btnCommit.addEventListener("click", () => tryCommit(false));
      btnCommitPush.addEventListener("click", () => tryCommit(true));

      window.addEventListener("message", (event) => {
        const msg = event.data;

        if (msg?.type === "state") {
          const s = msg.state || {};
          stagedCount = s.stagedCount ?? 0;

          stagedLabel.textContent = "Staged: " + stagedCount;
          errorEl.textContent = s.lastError ? String(s.lastError) : "";

          btnCommit.disabled = false;
          btnCommitPush.disabled = false;
          return;
        }

        if (msg?.type === "ui" && msg?.action === "setAmend") {
          amendEl.checked = Boolean(msg.value);
          persist();
          return;
        }

        if (msg?.type === "ui" && msg?.action === "setMessage") {
          messageEl.value = String(msg.value ?? "");
          persist();
          return;
        }
      });

      vscode.postMessage({ type: "ready" });
    </script>
  </body>
</html>
